# Webpack 编译流程简述
`Webpack` 作为前端开发中近几年来不可或缺的构建工具，我们有必要对其进行深度的学习，本文主要从编辑的角度简述其编译的过程。

## 先看一张流程图

![webpack-compile process img](https://user-gold-cdn.xitu.io/2019/9/5/16d00393b89a5d42?imageslim)

下面从这张图的流程简述整个编译过程。

我们将编译流程简单划分为三个阶段：**初始化阶段**、**编译阶段**、**输出阶段**。

### 初始化阶段
从上面的图我们基本大概也知道 `Webpack` 初始化阶段会做的一些前置工作，也主要分为三步：

1.初始化配置，这里的配置来源有两部分，一部分是我们在项目中常用到的通过配置文件的形式体现，还有一部分是在 `scripts` 通过 `Webpack` 命令启动的时候可能会加的一些选项；

2.创建 `Compiler` 对象，`Compiler` 对象是整个 `Webpack` 在构建过程中全局唯一的对象，包括开发模式下，它主要用来存放配置、处理文件监听、启动编译流程等，我们开发插件的时候，在实现 `apply` 方法参数中接收的其实就是这个对象；

3.从初始化的配置读取并加载插件，我们知道其实插件的原理就是通过监听 `Webpack` 编译阶段的事件流，然后拿到对应的资源进行处理，所以在编译阶段开始前需要先加载好插件。

在初始化阶段，`Compile` 对象就会触发一些钩子，下面简单列几个比较常用的钩子：
- 实例化 `Compiler`，使用前面的初始化配置创建一个全局唯一的 `Compiler` 对象；
- 加载插件，依次调用配置中的插件的 `apply` 方法，并将 `Compiler` 对象传递给插件，让插件可以监听后续的所有事件节点；
- `entry-option`，读取配置的 Entrys，为每个 Entry 实例化一个对应的 EntryPlugin，为后面该 Entry 的递归解析工作做准备。

### 编译阶段
编辑阶段就是 `Webpack` 构建过程中的重头戏了，这个过程实际上就是调用 `loader` 进行模块处理生成 `chunks`以及对 `chunks` 进行优化。在这个阶段中会生成一个 `Compilation` 对象，而这个对象跟 `Compiler` 类似，都继承自 `Tapable`（后面介绍一下）。它主要包含了当前模块的内容、编译后的模块内容、变化的文件等信息，但是与 `Compiler` 对象不同的是，如果在开发模式下，每次文件变动，都会创建一个新的 `Compilation` 对象。而触发真正编译的过程，实际也是从 `Compiler` 对象开始，我们大概列一下触发编译阶段过程中的一些钩子：
- run，就是开始启动一次全新的编译；
- compile，该事件是为了告诉插件一次新的编译将要启动，同时会给插件带上 compiler 对象；
- compilation，创建 `Compilation` 对象，在开发模式下，每一次文件变动，都会重新创建；
- make，一个新的 `Compilation` 创建完毕，`Webpack` 从 `entry` 开始读取文件，根据文件类型和配置的 Loader 对文件进行编译，编译完后再找出该文件依赖的文件，递归的编译和解析；
- after-compile，一次 `Compilation` 执行完成。这里会根据编译结果 合并出我们最终生成的文件名和文件内容。

当然，在 `Compilation` 对象处理模块的过程中，也会触发一些重要的事件：
- build-module，使用对应的 `loader` 去转化一个模块；
- normal-module-loader，在使用 `loader` 转化模块完成后，使用 `acorn` 将模块内容转化成 `ast`，然后交给 `Webpack` 进行其他处理；
- program，从上一步得到的 `ast`，然后根据 `ast` 进行模块依赖分析，并生成依赖列表；
- seal，所有模块解析完毕，最后根据依赖关系，生成新的 `chunks`。

整个编译过程比较复杂，中间可能会有很多的细节，这里只是简单的概述。

### 输出阶段
经历了编译阶段后，基本上每一次编译后的内容 `chunks` 已经生成，最后就是需要根据配置中的 `output` 配置，将编译后的内容写入到文件中，并根据配置生成到对应的文件夹下。这个阶段相对来说比较简单，就不过多描述了，下面也列出几个比较重要的事件：
- emit，确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容；
- after-emit，文件输出完毕；
- done，完成了一次编译和输出流程；
- failed，在整个处理流程中出现错误，可能就会跳过其中的一些阶段，直接到这个阶段，在这里可以获取到具体的错误信息。


## Tapable
在初始化阶段和编辑阶段，`Webpack` 创建了两个重要的对象：`Compiler` 和 `Compilation`，实际上这两个对象都是继承自 `Tapable` 的事件对象。所以在整个编译流程中，这些对象能通过触发不同的事件来将 `Webpack` 整个打包流程串联起来。而 `Tapable` 是一个 `Webpack` 官方自己封装的一个处理事件流的工具包，它的原理实际上就是一个发布订阅模式，类似于 `Node` 中的 `EventEmitter` 模块。`Tapable` 内部封装很多的事件 `hook`，包括处理同步事件和异步事件的，还有基于 `Promise` 的，下面是一张简单的图：

![Tapable hooks](https://user-gold-cdn.xitu.io/2019/9/5/16d003aab3c0b1cb?imageslim)

这里不详细展开介绍 `Tapable`，感兴趣可以去看它的源码：[tapable](https://github.com/webpack/tapable)。