# TSL/SSL协议概述
## 背景
随着Web发展到一定的阶段，网络通信的安全也成为了大家日益关注的问题。传统的HTTP协议存在着传输的数据被窃听、篡改、冒充的一系列风险，而TSL/SSL协议的出现就是为了解决这些安全问题。在HTTP基础上加了TSL/SSL层后，客户端和服务端通信的过程都是加密的，而且通信的时候配备证书，一旦数据被篡改，就能立刻被发现，然后停止通信。

## 基本的运行过程
TSL/SSL协议的背后的原理是使用加密算法，在通信的过程中，客户端首先问服务端索要公钥，然后用公钥加密信息，服务端收到加密的信息，用自己的私钥解密。

但是有两个问题需要注意。

1.如何保证公钥不被篡改？

答：将公钥放在数字证书中，只要保证证书是可靠的，那么公钥就是可靠的。

2.非对称加密计算量大，如何解决造成的通信效率问题？

答：每一次通信，可以理解一次 `session` 对话过程，客户端和服务端都会生成一个通信的 `session key`，用它来加密通信的信息。而 `session key` 对于通信信息加密是使用对称加密的算法，效率是比较高的。而服务器公钥只用于加密 `session key` 本身，这样就减少了加密运算的消耗时间。 

所以总结下来，使用SSL/TLS协议通信过程大概是这样的：

1.客户端向服务端索要并验证公钥；

2.双方协商生成 `session key`；

3.双方采用 `session key` 进行加密通信。

## 详细的握手过程
先看图示：

![tsl](./../image/v2-9f717c2d57cc29e7f473a500e01f9f6e_1440w.jpg)

1.Client Hello阶段

首先是客户端（一般是浏览器）向服务端发起通信请求，浏览器会将本身支持的协议版本、加密算法、压缩算法等信息发送给服务端，并且会附加一份随机生成的数，我们这里称为 `session ticket1`，用于后续生成 `session key`。

2.Server Hello阶段

服务端接收到客户端发送来的握手请求后，首先会将浏览器生成的 `session ticket1` 存起来，然后确定 `TLS` 版本、确认加密的算法，将网站的数字证书并且也生成一个随机的数，我们称为 `session ticket2` 返回给客户端。

3.客户端回应

客户端收到服务端回应后，先验证证书的有效性，域名是否和请求的一致，证书是否过期等。确定证书没有问题后，生成第三个随机数，这个随机数用从服务端获取的公钥加密，发送给服务端，这也意味客户端的握手结束。最后生成的随机数加上前面两个随机数就一共有三个随机数， 客户端和服务端用三个随机数使用约定的加密算法生成 `session key`，用于后续的通信。

4.服务端的最后回应

服务端收到第三个随机数后，计算生成本次回话使用的 `session key`，然后向客户端发送最后的信息：

1.服务端握手结束通知，表示服务端的握手阶段结束；

2.通信的编码改变，表示随后的信息将使用双方生成的 `session key` 和约定的加密算法进行通信。

上面就是整个握手的详细过程，随后客户端和服务端就用 `session key` 进行对称加密通信。

## Reference
- [SSL/TLS协议运行机制的概述](https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)
- [HTTPS入门, 图解SSL从回车到握手](https://zhuanlan.zhihu.com/p/25587986)
  
